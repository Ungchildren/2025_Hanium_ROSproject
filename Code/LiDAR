import rclpy
from rclpy.node import Node
from sensor_msgs.msg import LaserScan
from pymongo import MongoClient
import certifi
from rclpy.qos import QoSProfile, ReliabilityPolicy

class LidarMongoLoggerNode(Node):
    def __init__(self):
        super().__init__('lidar_node')

        # QoS ì„¤ì •: LiDAR í¼ë¸”ë¦¬ì…”ì™€ ë§ì¶”ê¸° ìœ„í•´ BEST_EFFORT
        qos = QoSProfile(depth=10)
        qos.reliability = ReliabilityPolicy.BEST_EFFORT

        # /scan í† í”½ êµ¬ë…
        self.subscription = self.create_subscription(
            LaserScan,
            '/scan',
            self.listener_callback,
            qos)

        # MongoDB ì—°ê²°
        uri = "mongodb+srv://ungchildren:ungchildren@ungchildren.mywuke3.mongodb.net/?retryWrites=true&w=majority&appName=Ungchildren"
        ca = certifi.where()
        self.client = MongoClient(uri, tlsCAFile=ca)
        self.db = self.client["robot_data"]
        self.collection = self.db["lidar"]

        self.get_logger().info("MongoDB ì—°ê²° ì™„ë£Œ ë° /scan êµ¬ë… ì‹œì‘")

        # ìƒíƒœ ë³€ê²½ ì¶”ì ìš©
        self.last_obstacle_state = None

    def listener_callback(self, msg: LaserScan):
        # ì¥ì• ë¬¼ ì¸ì‹ ê±°ë¦¬ ë²”ìœ„ (ë‹¨ìœ„: m)
        OBSTACLE_MIN = 0.05
        OBSTACLE_MAX = 0.3

        # ìœ íš¨ ë²”ìœ„ë§Œ í•„í„°ë§
        valid_ranges = [r for r in msg.ranges if OBSTACLE_MIN < r < OBSTACLE_MAX]

        # ì¥ì• ë¬¼ íŒë‹¨
        obstacle_detected = len(valid_ranges) > 0
        min_range = round(min(valid_ranges, default=100.0), 3)

        # ìƒíƒœ ë³€ê²½ì´ ìˆì„ ë•Œë§Œ ë¡œê·¸ ì¶œë ¥
        if obstacle_detected != self.last_obstacle_state:
            self.get_logger().info(
                f"ğŸ“¦ ìƒíƒœ ë³€ê²½ë¨ â†’ obstacle={obstacle_detected}, min={min_range} m"
            )
            self.last_obstacle_state = obstacle_detected

        # MongoDBì— ì €ì¥í•  ë¬¸ì„œ
        lidar_entry = {
            '_id': 'latest_lidar',
            'timestamp': self.get_clock().now().to_msg().sec,
            'obstacle_detected': obstacle_detected,
            'min_range_detected': min_range
        }

        try:
            self.collection.replace_one({'_id': 'latest_lidar'}, lidar_entry, upsert=True)
        except Exception as e:
            self.get_logger().error(f"âŒ MongoDB ì €ì¥ ì‹¤íŒ¨: {e}")

def main(args=None):
    rclpy.init(args=args)
    node = LidarMongoLoggerNode()
    try:
        rclpy.spin(node)
    except KeyboardInterrupt:
        pass
    finally:
        node.destroy_node()
        rclpy.shutdown()

if __name__ == '__main__':
    main()



